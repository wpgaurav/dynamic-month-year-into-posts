name: Release

on:
  release:
    types: [published]

env:
  PLUGIN_SLUG: dynamic-month-year-into-posts

jobs:
  build:
    name: Build Plugin Zip
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer:v2

      - name: Get version from tag
        id: get_version
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_VERSION#v}
          echo "VERSION=$VERSION" >> "$GITHUB_OUTPUT"
          echo "TAG=$TAG_VERSION" >> "$GITHUB_OUTPUT"

      - name: Verify version matches plugin
        env:
          TAG_VERSION: ${{ steps.get_version.outputs.VERSION }}
        run: |
          PLUGIN_VERSION=$(grep "Version:" "${PLUGIN_SLUG}.php" | head -1 | sed 's/.*Version:[[:space:]]*//' | tr -d '[:space:]')
          if [ "$PLUGIN_VERSION" != "$TAG_VERSION" ]; then
            echo "::error::Plugin version ($PLUGIN_VERSION) does not match tag version ($TAG_VERSION)"
            exit 1
          fi
          echo "Version verified: $PLUGIN_VERSION"

      - name: Install npm dependencies
        run: npm ci

      - name: Build assets
        run: npm run build

      - name: Generate production vendor
        run: |
          VENDOR_TMP=$(mktemp -d)
          cp composer.json composer.lock "$VENDOR_TMP/"
          composer install --no-dev --optimize-autoloader --no-interaction --working-dir="$VENDOR_TMP"
          echo "VENDOR_TMP=$VENDOR_TMP" >> "$GITHUB_ENV"

      - name: Assemble distribution
        run: |
          mkdir -p "build-release/${PLUGIN_SLUG}"

          # Use .distignore as single source of truth.
          rsync -a \
            --exclude-from=".distignore" \
            --exclude="build-release" \
            . "build-release/${PLUGIN_SLUG}/"

          # Inject production vendor + composer.json (excluded by .distignore).
          cp -r "$VENDOR_TMP/vendor" "build-release/${PLUGIN_SLUG}/"
          cp composer.json "build-release/${PLUGIN_SLUG}/"

          # Clean artifacts.
          find build-release -name ".DS_Store" -delete 2>/dev/null || true
          find build-release -name "*.map" -delete 2>/dev/null || true
          find build-release -type d -empty -delete 2>/dev/null || true

      - name: Verify distribution
        run: |
          DIST="build-release/${PLUGIN_SLUG}"
          MISSING=0

          for f in \
            "${PLUGIN_SLUG}.php" \
            "index.php" \
            "uninstall.php" \
            "readme.txt" \
            "composer.json" \
            "vendor/autoload.php" \
            "build/index.js" \
            "includes/shortcodes.php" \
            "src/Plugin.php" \
            "src/blocks/dynamic-date/render.php"; do
            if [ ! -f "$DIST/$f" ]; then
              echo "::error::Missing critical file: $f"
              MISSING=$((MISSING + 1))
            fi
          done

          if [ "$MISSING" -gt 0 ]; then
            echo "::error::Distribution is incomplete"
            exit 1
          fi

          # Check for dev dependency leaks.
          if [ -d "$DIST/vendor/phpstan" ] || \
             [ -d "$DIST/vendor/phpunit" ] || \
             [ -d "$DIST/vendor/squizlabs" ]; then
            echo "::error::Dev dependencies leaked into vendor/"
            exit 1
          fi

          echo "Distribution verified"
          find "$DIST" -type f | wc -l | xargs -I{} echo "File count: {}"

      - name: Create zip file
        id: zip
        env:
          VERSION: ${{ steps.get_version.outputs.VERSION }}
        run: |
          cd build-release
          ZIP_NAME="${PLUGIN_SLUG}-${VERSION}.zip"
          zip -rq "../${ZIP_NAME}" "${PLUGIN_SLUG}"
          cd ..
          echo "ZIP_NAME=${ZIP_NAME}" >> "$GITHUB_OUTPUT"
          ls -lh "${ZIP_NAME}"

      - name: Generate checksums
        env:
          ZIP_NAME: ${{ steps.zip.outputs.ZIP_NAME }}
        run: |
          sha256sum "$ZIP_NAME" > "${ZIP_NAME}.sha256"
          md5sum "$ZIP_NAME" > "${ZIP_NAME}.md5"
          echo "SHA256: $(cat "${ZIP_NAME}.sha256")"

      - name: Upload plugin zip to release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ steps.zip.outputs.ZIP_NAME }}
            ${{ steps.zip.outputs.ZIP_NAME }}.sha256
            ${{ steps.zip.outputs.ZIP_NAME }}.md5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PLUGIN_SLUG }}-${{ steps.get_version.outputs.VERSION }}
          path: ${{ steps.zip.outputs.ZIP_NAME }}
          retention-days: 90
